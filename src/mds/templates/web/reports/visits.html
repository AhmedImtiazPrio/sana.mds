{% extends 'web/base.html' %}
{% load i18n %}
{% load google %}
{% block title %}{% trans 'Patient Visits' %}{% endblock %}
{% block srcscript %}
  {{ block.super }} 
  <script type="text/javascript" src="{{ STATIC_PREFIX }}web/js/maps.js"></script>
{% endblock %}
{% block extrascript %}{% endblock %}
{% block extrastyle %}
  <link rel="stylesheet" href="{{ STATIC_PREFIX }}web/css/reports.css">
{% endblock %}
{% block header %}{% trans 'Patient Visits' %}{% endblock %}
{% block content %}
<!-- select observer -->
<div class="summary-selector">
    <div>
    <ul>
        <li>
            <label>{% trans 'Select worker' %}</label>
            <select id="id_worker">
                <option value="" selected="selected">------------</option>
            {% for object in observers %}
                <option value="{{ object.uuid }}" {% if object.uuid == selected.uuid %}selected{% endif %}>{{ object }}</option>
            {% endfor %}
            </select>
        </li>
        <li>{% trans 'Start date' %} <input id="id_start_date" type="date" /></li>
        <li>{% trans 'End date' %} <input id="id_end_date" type="date" /></li>
        <li>
            {% trans 'Operation' %}
            <select id="id_operation">
                <option value="" selected="selected">------------</option>
            {% for object in operations %}
                <option value="{{ object.0 }}" {% if object.0 == operation %}selected{% endif %}>{{ object.1 }}</option>
            {% endfor %}
            </select>
        </li>
    </ul>
    </div>
    <hr/>
    <div>
    <ul>
        <li>
            <label>{% trans 'Location' %}</label>
            <select id="id_location">
                <option value="" selected="selected">------------</option>
            {% for object in locations %}
                {% if object.uuid == location.uuid %}
                    <option value="{{ object.uuid }}" selected>{{ object }}</option>
                {% else %}
                    <option value="{{ object.uuid }}">{{ object }}</option>
                {% endif %}
            {% endfor %}
            </select>
        </li>
        <li>
            <label for="id_gender">{% trans 'Gender' %}</label>
            <select id="id_gender">
                <option value="" selected="selected">------------</option>
                <option value="M">{% trans 'Male' %}</option>
                <option value="F">{% trans 'Female' %}</option>
            </select>
        </li>
        <li><label>{% trans 'Min age' %}</label><input id="id_min_age" type="number" /></li>
        <li><label>{% trans 'Max age' %}</label><input id="id_max_age" type="number" /></li>
        </ul>
        </div>
        <div>
          <button id="id_submit">{% trans 'Update' %}</button>
        </div>
    <hr/>
</div>
<script>
function reload(selected, startdate, enddate){
    var q = { 
        "selected" : selected,
        "start": startdate.toISOString(),
        "end" : enddate.toISOString(),
    };
    var qs = $.param(q);
    window.location = "/mds/web/report/visits/?" + qs;

};
function changePeriod(selected, year,month){
    var q = { 
        "selected" : selected,
        "month" : month,
        "year" : year
    };
    var qs = $.param(q);
    window.location = "/mds/web/report/visits/?" + qs;

};
$('#id_worker').change(function() {
    reload($(this).val(), $('#id_start_date').datepicker('getDate'),$('#id_end_date').datepicker('getDate'));
});
$('#id_submit').click(function() {
    reload($('#id_worker').val(), $('#id_start_date').datepicker('getDate'),$('#id_end_date').datepicker('getDate'));
});

</script>
<script>
    // Displays Date picker pop up
    $(function(){
        $('input[type="date"]').datepicker({
            changeMonth: true,
            changeYear: true,
            showButtonPanel: true, 
            dateFormat: 'yy-mm-dd', 
            altFormat: "yy-mm-dd",
            yearRange : "c-100:c+05",
        }).prop('type','text');
        $('#id_start_date').datepicker('setDate', new Date('{{ start }}'));
        $('#id_end_date').datepicker('setDate', new Date('{{ end }}'));
     }); 
</script>
<!-- load summary of assigned visits -->
<div>
<div style="display:block;">
  <div id="map" class="toggle" style="height:684px;width:100%;zindex:-1"></div>
</div>
</div>
<script>
    var w = window.innerWidth - 32;
    $('#map').width(w);
    function initMap() {
    var myLatLng = { lat: {% GOOGLE_MAP_LAT %}, lng: {% GOOGLE_MAP_LNG %} };
    var map = new google.maps.Map(document.getElementById('map'), {
        zoom: 12,
        center: myLatLng
    });
    {% for encounter in encounters %}
    addMarker("{{ encounter.observer.uuid }}",
        map,{{ encounter.location.latitude}}, 
        {{ encounter.location.longitude }});
    {% endfor %}
    };
    window.addEventListener("resize", function(){
        var w = window.innerWidth - 32;
        $('#map').width(w);
    });
    </script>
    <script async defer
        src="https://maps.googleapis.com/maps/api/js?key={% GOOGLE_API_KEY %}&signed_in=true&callback=initMap">
    </script>
<div class="" style="display:inline-block;">
  <h3>{% trans 'Summary' %}: {% if selected %}{{ selected }}{% else %}{% trans 'All' %}{% endif %} {% trans 'From' %}: {{ start }} {% trans 'To' %}: {{ end }}</h3>
  <ul>
    <li>{% trans 'Tasks Due' %}: {{ tasks }}</li>
    <li>{% trans 'Completed' %}: {{ completed_tasks }}</li>
    <li>{% trans 'Late' %}: {{ late_tasks }}</li>
    <li>{% trans 'Number of visits' %}: {{ encounters|length }}</li>
  </ul>
</div>
<div>
<h3>{% trans 'Patient Visits' %}</h3>
</div>
<ul>
{% for encounter in encounters %}
    {% with location=encounter.location %}
    <li class="{% cycle 'even-row' 'odd-row' %}">
    <div id="id_{{ encounter.uuid }}">
    <h4>{{ encounter.created }}, {{ encounter.subject }}</h4>
    {{ encounter.procedure }}<br/>
    {{ encounter.observer }}
    </div>
    <script>
        $('#id_{{ encounter.uuid }}').click(function() {
            window.open("{% url 'web:encounter-detail' encounter.id %}");
        });
    </script>
    </li>
    {% endwith %}
{% endfor %}
</ul>

{% endblock content %}
