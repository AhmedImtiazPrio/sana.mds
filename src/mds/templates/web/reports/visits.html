{% extends 'web/base.html' %}
{% load i18n %}
{% load google %}
{% block title %}{% trans 'Patient Visits' %}{% endblock %}
{% block extrascript %}{% endblock %}
{% block extrastyle %}
<link rel="stylesheet" href="{{ STATIC_PREFIX }}web/css/reports.css">
<style>
.ui-datepicker-calendar {
    display: none;
}
</style>
{% endblock %}
{% block header %}{% trans 'Patient Visits' %}{% endblock %}
{% block content %}
<!-- select observer -->
<div class="summary-selector">
    <h2>{% trans 'Select worker' %}</h2>
    <table>
    <tr>
        <td>
            <select id="id_worker">
                <option value="" selected="selected">------------</option>
            {% for object in observers %}
                {% if object.uuid == selected.uuid %}
                    <option value="{{ object.uuid }}" selected>{{ object }}</option>
                {% else %}
                    <option value="{{ object.uuid }}">{{ object }}</option>
                {% endif %}
            {% endfor %}
            </select>
        </td>
        <td>{% trans 'Month' %} <input id="id_date" type="date" /></td>
    <tr>
    </table>
    <hr/>
</div>
<script>
function reload(selected, date){
    var q = { 
        "selected" : selected,
        "month" : date.getUTCMonth() + 1,
        "year" : date.getUTCFullYear() 
    };
    var qs = $.param(q);
    window.location = "/mds/web/report/visits/?" + qs;

};
function changePeriod(selected, year,month){
    var q = { 
        "selected" : selected,
        "month" : month,
        "year" : year
    };
    var qs = $.param(q);
    window.location = "/mds/web/report/visits/?" + qs;

};
$('#id_worker').change(function() {
    reload($(this).val(), $('#id_date').datepicker('getDate'));
});
$('#id_date').change(function() {
    reload($('#id_worker').val(),$(this).datepicker('getDate'));
});

</script>
<script>
    // Displays Date picker pop up
    $(function(){
        $('input[type="date"]').datepicker({
            buttonImageOnly: true,
            changeMonth: true,
            changeYear: true,
            showButtonPanel: true, 
            dateFormat: 'yy-mm', 
            altFormat: "yy-mm-dd",
            yearRange : "c-100:c+05",
            onClose: function(dateText, inst) { 
                var oldValue = $(this).data('oldValue') || "";
                var oldValue = dateText+"-01";
                var month = $("#ui-datepicker-div .ui-datepicker-month :selected").val();
                var year = $("#ui-datepicker-div .ui-datepicker-year :selected").val();
                var date = new Date(year, month, 1);
                $(this).datepicker('setDate', new Date(year, month, 1));
                var dateStr = $.datepicker.formatDate('yy-mm-dd', date);
                if (dateStr !== oldValue) {
                    changePeriod($('#id_worker').val(), year, parseInt(month) + 1);
                }
                $(this).data('oldValue',dateStr);
            }
        }).prop('type','text');
        var month = parseInt({{ month }}) -1;
        $('#id_date').datepicker('setDate', new Date({{ year }}, month, 1));
        //$('#id_date').val("{{ year }}-{{ month }}");
     }); 
</script>
<!-- load summary of assigned visits -->
<div class>
<h3>{% trans 'Summary' %} {% if selected %}{{ selected }}{% else %}{% trans 'All' %}{% endif %}</h3>
<h4>{% trans 'Month' %} {{ month }} {% trans 'Year' %} {{ year }}</h4>
<ul>
<li>{% trans 'Tasks Due' %} {{ tasks }}</li>
<li>{% trans 'Completed' %} {{ completed_tasks }}</li>
<li>{% trans 'Late' %} {{ late_tasks }}</li>
</ul>
</div>
<div>
<h3>{% trans 'Patient Visits' %}</h3>
<div>
{% trans 'Number of visits' %}:{{ encounters|length }} 
</div>
<ul>
{% for encounter in encounters %}
    {% with location=encounter.location %}
    <li class="{% cycle 'even-row' 'odd-row' %}">
    <h4>{{ encounter.created }}, {{ encounter.subject }}</h4>
    {{ encounter.procedure }}
    </li>
    {% endwith %}
{% endfor %}
</ul>
</div>
<div id="map" style="width: 500px; height: 400px;"></div>
<script>
    function initMap() {
    var myLatLng = { lat: {% GOOGLE_MAP_LAT %}, lng: {% GOOGLE_MAP_LNG %} };
    var map = new google.maps.Map(document.getElementById('map'), {
        zoom: 12,
        center: myLatLng
    });
    var markers = [];
    var marker;
    {% for encounter in encounters %}
    markers.push(new google.maps.Marker({
        position: new google.maps.LatLng({{ encounter.location.latitude}}, {{ encounter.location.longitude }}),
        map: map
        }));
    {% endfor %}
    var markerCluster = new MarkerClusterer(map, markers);
    };
    </script>
    <script async defer
        src="https://maps.googleapis.com/maps/api/js?key={% GOOGLE_API_KEY %}&signed_in=true&callback=initMap">
    </script>
  
{% endblock content %}
