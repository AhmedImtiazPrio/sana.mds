{% extends 'web/base.html' %}
{% load i18n %}
{% load google %}
{% block title %}{% trans 'Patient Visits' %}{% endblock %}
{% block srcscript %}
  {{ block.super }} 
  <script type="text/javascript" src="{{ STATIC_PREFIX }}web/js/maps.js"></script>
{% endblock %}
{% block extrascript %}{% endblock %}
{% block extrastyle %}
  <link rel="stylesheet" href="{{ STATIC_PREFIX }}web/css/reports.css">
{% endblock %}
{% block header %}{% trans 'Patient Visits' %}{% endblock %}
{% block content %}
<!-- select observer -->
<div class="summary-selector">
    <h2>{% trans 'Select worker' %}</h2>
    <table>
    <tr>
        <td>
            <select id="id_worker">
                <option value="" selected="selected">------------</option>
            {% for object in observers %}
                {% if object.uuid == selected.uuid %}
                    <option value="{{ object.uuid }}" selected>{{ object }}</option>
                {% else %}
                    <option value="{{ object.uuid }}">{{ object }}</option>
                {% endif %}
            {% endfor %}
            </select>
        </td>
        <td>{% trans 'Start date' %} <input id="id_start_date" type="date" /></td>
        <td>{% trans 'End date' %} <input id="id_end_date" type="date" /></td>
    <tr>
    </table>
    <hr/>
</div>
<script>
function reload(selected, startdate, enddate){
    var q = { 
        "selected" : selected,
        "start": startdate.toISOString(),
        "end" : enddate.toISOString(),
    };
    var qs = $.param(q);
    window.location = "/mds/web/report/visits/?" + qs;

};
function changePeriod(selected, year,month){
    var q = { 
        "selected" : selected,
        "month" : month,
        "year" : year
    };
    var qs = $.param(q);
    window.location = "/mds/web/report/visits/?" + qs;

};
$('#id_worker').change(function() {
    reload($(this).val(), $('#id_start_date').datepicker('getDate'),$('#id_end_date').datepicker('getDate'));
});
$('#id_date').change(function() {
    reload($('#id_worker').val(), $('#id_start_date').datepicker('getDate'),$('#id_end_date').datepicker('getDate'));
});

</script>
<script>
    // Displays Date picker pop up
    $(function(){
        $('input[type="date"]').datepicker({
            changeMonth: true,
            changeYear: true,
            showButtonPanel: true, 
            dateFormat: 'yy-mm-dd', 
            altFormat: "yy-mm-dd",
            yearRange : "c-100:c+05",
        }).prop('type','text');
        $('#id_start_date').datepicker('setDate', new Date('{{ start }}'));
        $('#id_end_date').datepicker('setDate', new Date('{{ end }}'));
     }); 
</script>
<!-- load summary of assigned visits -->
<div>
<div class="" style="display:inline-block;">
  <h3>{% trans 'Summary' %} {% if selected %}{{ selected }}{% else %}{% trans 'All' %}{% endif %}</h3>
  <h4>{% trans 'From' %}: {{ start }} {% trans 'To' %}: {{ end }}</h4>
  <ul>
    <li>{% trans 'Tasks Due' %} {{ tasks }}</li>
    <li>{% trans 'Completed' %} {{ completed_tasks }}</li>
    <li>{% trans 'Late' %} {{ late_tasks }}</li>
    <li>{% trans 'Number of visits' %}:{{ encounters|length }}</li>
  </ul>
</div>
<div style="display:inline-block;">
  <div id="map" class="toggle" style="height:684px;width:684px;zindex:-1"></div>
</div>
</div>
<script>
    function initMap() {
    var myLatLng = { lat: {% GOOGLE_MAP_LAT %}, lng: {% GOOGLE_MAP_LNG %} };
    var map = new google.maps.Map(document.getElementById('map'), {
        zoom: 12,
        center: myLatLng
    });
    {% for encounter in encounters %}
    addMarker("{{ encounter.observer.uuid }}",
        map,{{ encounter.location.latitude}}, 
        {{ encounter.location.longitude }});
    {% endfor %}
    };
    </script>
    <script async defer
        src="https://maps.googleapis.com/maps/api/js?key={% GOOGLE_API_KEY %}&signed_in=true&callback=initMap">
    </script>
<div>
<h3>{% trans 'Patient Visits' %}</h3>
</div>
<ul>
{% for encounter in encounters %}
    {% with location=encounter.location %}
    <li class="{% cycle 'even-row' 'odd-row' %}">
    <h4>{{ encounter.created }}, {{ encounter.subject }}</h4>
    {{ encounter.procedure }}<br/>
    {{ encounter.observer }}
    </li>
    {% endwith %}
{% endfor %}
</ul>

{% endblock content %}
